image: ruby:2.4.2
services:
  - mdillon/postgis:latest

variables:
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: ""

before_script:
  # Use UTF8
  - export LC_ALL=en_US.UTF-8
  - export LANG=en_US.UTF-8
  - export LANGUAGE=en_US.UTF-8

  # Set to UTC
  - export TZ='Etc/UTC'

  # Install ssh-agent if not already installed, it is required by Docker.
  # (change apt-get to yum if you use a CentOS-based image)
  - which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )

  # Run ssh-agent (inside the build environment)
  - eval $(ssh-agent -s)

  # Add the SSH key stored in SSH_PRIVATE_KEY variable to the agent store
  - ssh-add <(echo "$SSH_PRIVATE_KEY")

  # Add new dependencies below
  - apt-get update -y && apt-get install cmake -y

  - gem install bundler --no-document
  - cp test/dummy/config/database.yml.gitlab test/dummy/config/database.yml
  - bundle install --jobs $(nproc) "${FLAGS[@]}"

stages:
  - test

test:
  stage: test
  script:
    - bundle exec rails db:setup RAILS_ENV=test
    - bundle exec rails app:assets:precompile RAILS_ENV=test
    - bundle exec rails test

rubocop:
  stage: test
  script:
    - bundle exec rubocop
